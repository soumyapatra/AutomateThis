import base64
import csv
import hashlib
import logging

from Crypto.Cipher import ChaCha20

from datetime import datetime, timedelta

from pscore.settings import (
    AUTH_TOKEN_PREFIX,
    ENCODE_KEY,
    MWEB_URL,
)
from users.models_dir.base import ExternalRegistration

LOGGER = logging.getLogger(__name__)


class GenerateMwebUrl:

    @staticmethod
    def get_current_timestamp():
        return datetime.utcnow().isoformat()

    @staticmethod
    def parse_timestamp(timestamp_str):
        return datetime.fromisoformat(timestamp_str)

    @classmethod
    def is_valid_timestamp(cls, timestamp_str, expiration_minutes=480):
        timestamp = cls.parse_timestamp(timestamp_str)
        current_time = datetime.utcnow()
        expiration_time = timestamp + timedelta(minutes=expiration_minutes)
        return current_time <= expiration_time

    @staticmethod
    def generate_key_from_string(input_string):
        hash_object = hashlib.sha256(input_string.encode())
        key = hash_object.digest()
        return key

    @classmethod
    def encrypt_message(cls, message, key=ENCODE_KEY):
        key_input_string = key
        key = cls.generate_key_from_string(key_input_string)
        cipher = ChaCha20.new(key=key)

        # Encrypt the message
        encrypted_bytes = cipher.encrypt(message.encode("utf-8"))

        # Encode the nonce and the encrypted bytes to Base64
        encrypted_message = base64.b64encode(cipher.nonce + encrypted_bytes).decode("utf-8")

        return encrypted_message


    @classmethod
    def generate_auth_token(cls, lead_token):
        token_message = f"{AUTH_TOKEN_PREFIX}{lead_token}#{cls.get_current_timestamp()}"
        auth_token = cls.encrypt_message(message=token_message)
        return auth_token

    @classmethod
    def generate_url(cls, master_user_id, lead_token):
        token = cls.generate_auth_token(lead_token)
        response = cls.generate_mweb_url(master_user_id, token)
        return response

    @classmethod
    def generate_url_for_users(cls, master_user_id_list):
        url_list = []
        failed_users = []
        for master_user_id in master_user_id_list:
            try:
                external_reg = ExternalRegistration.objects.get(master_user_id=master_user_id, channel_id__in=[2345, 233, 4334, 2896, 2930, 3126, 2897])
                generated_url = cls.generate_url(master_user_id, external_reg.lead_token)
                url_list.append(generated_url)
            except Exception as e:
                LOGGER.error(f"Failed to generate for user_id: {master_user_id} , error: {e}")
                failed_users.append(master_user_id)
        LOGGER.error(f"Failed users: {failed_users}")
        cls.generate_csv(url_list)

    @classmethod
    def generate_mweb_url(cls, master_user_id, token):
        return {master_user_id, f"{MWEB_URL}?token={token}"}

    @classmethod
    def generate_csv(cls, url_list):
        base_path = "/tmp/mweb_url_campaign/"
        file_path = base_path + "mweb_urls.csv"
        with open(file_path, "w", newline="") as file:
            field_names = ["master_user_id", "mweb_url"]
            writer = csv.DictWriter(file, fieldnames=field_names, delimiter=",")
            writer.writerows(url_list)


users = [32023213,32054700,31795447,31827113,31517391,31572759,31387455,31394260,31303873,31318235,31321028,31348236,31461128,31482625,31500742,31402453,31889584,31902061,31906252,31704056,31705324,31708463,31736061,31738241,31738319,31774214,31777277,31664003,31677329,31685425,31686166,32011496,32015186,32015823,32016008,31960275,31961293,30036296,30232553,30337172,30309238,30269712,29876446,29888563,29836000,30371791,30390553,30404663,30062430,30073343,30141935,30100928,30101549,30440823,32370380,32433223,32076518,32077379,32277217,32561123,32561382,32561609,32561700,32561800,32562200,32562296,32562313,32562348,32562812,32563392,32563521,32564012,32564474,32564580,32564704,32564977,32565417,32565914,32566448,32566766,32566843,32568200,32569738,32571365,32572401,32572433,32572442,32572527,32572941,32573524,32573578,32573588,32573739,32574001,32574015,32574036,32574170,32574317,32574342,32574401,32574449,32574541,32574550,32574599,32574652,32574718,32574756,32574767,32574774,32574858,32574971,32575006,32575123,32575150,32575271,32575361,32575511,32575557,32575558,32575841,32575872,32575915,32575945,32576008,32576122,32576533,32577399,32578378,32578532,32578613,32578632,32578705,32578740,32578766,32578807,32578831,32578849,32578887,32579138,32579158,32579318,32579469,32579539,32579627,32580045,32580166,32580234,32580476,32580573,32580718,32580829,32580889,32580988,32581184,32581492,32581563,32582235,32582283,32582627,32583151,32584511,32584541,32584852,32584942,32585045,32585115,32585144,32585194,32585235,32585350,32586003,32586114,32586227,32586577,32586693,32586776,32587252,32587268,32587323,32587353,32587563,32587587,32587789,32587892,32588633,32588809,32588972,32589162,32590479,32590914,32591469,32591499,32591566,32591621,32591737,32591923,32591968,32592104,32592153,32592281,32592395,32592475,32592583,32592742,32592816,32593363,32593394,32593661,32593690,32593832,32593979,32594231,32594256,32594316,32595047,32595113,32691572,32691578,32691591,32691595,32691598,32691604,32691605,32691613,32691617,32691620,32691623,32691625,32691634,32691636,32691640,32691641,32691651,32691652,32691653,32691656,32691661,32691665,32691667,32691669,32691672,32691673,32691676,32691681,32691685,32691686,32691692,32691693,32691698,32691702,32691708,32691709,32691717,32691721,32691723,32691729,32691731,32691737,32691746,32691747,32691758,32691770,32691785,32691792,32691793,32691800,32691802,32691809,32691822,32691825,32691827,32691829,32692448,32692479,32692508,32692511,32692531,32692555,32692584,32692591,32692620,32692667,32692850,32692881,32692893,32692917,32692972,32693091,32693137,32693166,32693239,32693255,32693275,32693355,32693381,32693492,32693526,32693629,32693698,32693715,32693812,32693834,32693988,32693989,32694012,32694031,32694226,32694289,32694295,32694336,32694349,32694352,32694409,32694427,32694436,32694442,32694466,32694475,32694476,32694487,32694498,32694513,32694566,32694647,32694667,32694705,32694818,32694855,32694880,32694888,32694893,32694896,32694903,32694907,32694912,32694915,32694918,32694931,32694934,32694940,32694949,32694952,32694958,32694967,32694974,32694977,32694987,32695010,32695013,32695036,32695052,32695067,32695072,32695076,32695078,32695082,32695086,32695094,32695115,32695129,32695132,32695141,32695142,32695145,32695157,32695168,32695174,32695176,32695178,32695180,32695183,32695193,32695201,32695207,32695217,32695219,32695232,32695233,32695257,32695366,32695480,32695509,32695600,32696639,32696666,32696791,32696798,32696914,32697040,32697113,32697135,32697146,32697240,32697271,32697281,32697312,32697314,32697325,32697347,32697566,32697598,32697643,32697693,32697821,32697844,32697857,32697908,32698019,32698042,32698143,32698306,32698390,32698403,32698415,32698417,32698429,32698544,32698669,32698845,32699064,32699091,32699097,32699101,32699104,32699139,32699141,32699145,32699149,32699151,32699164,32699173,32699201,32699205,32699218,32699236,32699248,32699249,32699261,32699264,32699273,32699286,32699293,32699302,32699315,32699321,32699333,32699344,32699364,32699368,32699375,32699377,32699381,32699393,32699396,32699397,32699404,32699409,32699412,32699421,32699428,32699439,32699452,32699455,32699464,32699492,32699497,32699505,32699508,32699509,32699521,32699530,32699532,32699546,32699549,32699560,32699564,32699665,32700055,32700325,32700654,32700734,32700777,32700838,32700845,32700854,32700952,32701104,32701142,32701273,32701394,32701448,32701481,32701594,32701647,32701756,32701806,32701901,32702097,32702158,32702175,32702361,32702436,32702628,32702699,32702715,32702792,32702799,32702821,32702832,32702859,32702923,32702950,32703037,32703072,32703167,32703204,32703421,32703640,32703720,32703847,32703971,32703999,32704251,32704271,32704543,32704555,32704564,32704569,32704586,32705058,32705079,32705088,32705097,32705142,32705148,32705153,32705186,32705201,32705213,32705222,32705234,32705236,32705239,32705254,32705259,32705280,32705303,32705307,32705315,32705322,32705327,32705331,32705335,32705341,32705345,32705356,32705373,32705381,32705389,32705401,32705404,32705412,32705417,32705419,32705425,32705453,32705478,32705490,32705494,32705502,32705514,32705517,32705520,32705523,32705528,32705539,32705542,32706050,32706422,32707032,32707176,32707191,32707239,32707264,32707315,32707445,32707712,32708227,32708236,32708327,32708343,32708577,32708632,32708656,32708756,32708783,32708791,32708869,32709001,32709270,32709328,32709869,32710029,32710234,32710275,32710598,32710615,32710622,32710845,32710860,32711068,32711135,32711174,32711566,32711576,32711747,32711786,32711798,32712139,32712156,32712162,32712164,32712177,32712192,32712201,32712215,32712232,32712249,32712254,32712267,32712272,32712275,32712300,32712337,32712345,32712354,32712358,32712368,32712404,32712435,32712439,32712448,32712453,32712459,32712466,32712469,32712485,32712487,32712648,32713666,32714039,32714293,32714827,32714871,32714991,32715093,32715115,32715210,32715243,32715289,32715354,32715649,32715680,32715761,32715798,32715830,32715875,32715931,32715976,32715998,32716028,32716036,32716055,32716098,32716115,32716142,32716161,32716237,32716412,32716460,32716466,32716478,32716544,32716696,32716762,32716787,32716798,32716857,32716919,32716966,32717004,32717588,32717618,32717783,32717950,32718133,32718435,32718473,32718584,32718649,32718724,32718908,32718963,32719119,32719183,32719208,32719293,32719456,32719484,32719550,32719590,32719626,32719641,32719655,32719658,32719868,32719875,32720101,32720106,32720110,32720164,32720664,32720867,32720870,32721384,32721668,32722506,32723324,32723396,32723594,32723974,32725313,32725362,32726189,32727854,32728462,32728618,32728694,32728719,32728723,32728863,32728887,32728918,32728947,32728948,32728951,32728989,32728991,32728996,32729097,32729225,32729493,32729899,32730318,32730334,32730526,32730553,32730570,32730625,32730687,32730850,32730930,32731064,32731190,32731466,32731668,32731709,32732037,32732102,32732224,32732341,32732606,32732899,32732939,32732952,32732993,32733030,32733039,32733058,32733060,32733082,32733088,32733121,32733135,32733153,32733159,32733163,32733166,32733172,32733176,32733192,32733202,32733204,32733210,32733212,32733219,32733225,32733243,32733244,32733245,32733258,32733266,32733271,32733275,32733289,32733314,32733321,32733323,32733333,32733334,32733342,32733348,32733368,32733378,32733390,32733396,32733410,32733414,32733418,32733430,32733449,32733472,32733480,32733482,32733494,32733501,32733514,32733523,32733530,32733543,32733551,32733553,32733563,32733566,32733583,32733586,32733596,32733614,32733630,32733637,32733645,32733654,32733663,32733667,32733671,32733701,32733709,32733736,32733744,32733748,32733754,32733764,32733785,32733788,32733796,32733801,32733805,32734197,32734211,32734394,32680548,32680568,32680644,32680717,32680759,32680843,32680889,32680921,32680924,32681000,32681021,32681107,32681125,32681142,32681208,32681279,32681320,32681372,32681420,32681440,32681465,32681539,32681550,32681569,32681804,32681931,32681935,32681977,32682011,32682180,32682245,32682292,32682294,32682393,32682426,32682448,32682500,32683278,32684046,32684065,32684286,32684319,32684326,32684569,32684665,32684893,32685932,32685995,32686285,32687831,32687883,32687996,32688043,32688098,32688163,32688235,32688290,32688391,32688473,32688673,32689016,32689087,32689189,32689232,32689267,32689626,32689809,32689823,32689837,32689936,32689952,32689989,32690011,32690079,32690127,32690228,32690288,32690569,32690747,32690816,32691075,32691359,32691511,32691520,32691527,32691535,32691549,32691563,32691567,32597108,32597415,32597432,32597511,32597562,32597578,32597580,32597710,32597844,32598105,32598169,32598171,32598247,32598336,32598456,32598473,32598536,32598560,32599822,32600399,32600453,32600527,32601072,32601238,32601296,32601311,32603291,32603675,32603745,32603805,32603966,32604363,32604608,32604677,32604739,32604984,32605221,32605330,32605506,32605657,32605904,32605936,32605985,32607001,32607260,32607437,32608266,32609189,32610843,32616967,32617300,32617316,32617370,32617378,32617538,32617748,32618792,32619053,32619517,32620240,32620424,32620516,32620882,32621148,32621205,32621948,32622032,32622258,32623025,32623277,32623418,32623513,32624264,32625035,32625176,32625224,32625467,32625512,32626194,32626208,32626416,32626490,32626565,32626623,32626657,32626764,32626810,32629052,32629143,32629339,32629341,32629361,32629371,32629385,32629438,32629454,32629626,32629794,32630014,32630081,32630146,32630220,32630288,32630371,32630398,32630534,32630814,32631449,32631691,32631914,32632347,32632682,32633439,32633826,32633912,32633915,32633940,32633962,32634014,32634021,32634185,32634335,32634493,32634516,32634610,32634785,32634827,32634831,32634850,32634905,32635052,32635137,32635266,32635331,32635397,32635467,32636140,32636197,32636215,32636315,32636318,32636382,32636392,32636417,32636476,32636536,32636610,32636659,32636679,32636742,32636755,32636772,32636781,32636845,32637015,32637158,32637169,32637481,32637599,32637618,32637635,32637638,32638546,32639431,32639692,32639722,32639858,32640062,32640075,32640132,32640521,32640809,32640866,32641229,32641340,32641351,32641377,32641640,32641680,32641721,32641811,32641975,32642164,32642186,32642280,32642452,32642585,32642715,32642743,32642749,32642753,32642754,32642829,32642898,32642909,32642977,32643009,32643041,32643328,32644389,32644533,32644777,32645136,32645199,32645246,32645249,32645321,32645391,32645498,32645663,32645682,32645821,32646193,32646258,32646438,32646957,32647199,32647237,32647253,32647269,32647281,32647308,32647406,32647414,32647439,32647472,32647483,32647509,32647987,32648283,32649977,32650021,32650954,32651339,32653521,32654207,32654448,32654510,32654775,32654785,32654799,32655046,32655099,32655172,32655245,32655252,32655308,32655419,32655490,32655528,32655622,32655730,32655895,32655947,32656146,32656334,32656456,32656813,32656860,32656893,32656975,32657321,32657582,32657632,32657739,32657871,32658037,32659325,32660428,32660498,32660506,32660536,32660588,32660924,32660961,32660962,32660997,32661014,32661176,32661239,32661257,32661314,32661374,32661387,32661411,32661417,32661423,32661463,32661476,32661682,32661762,32661777,32661802,32662022,32662148,32662257,32662530,32662548,32662552,32662615,32662721,32663384,32663558,32663678,32663954,32664117,32664165,32664179,32664303,32664313,32665779,32666112,32666160,32666642,32667286,32667543,32667712,32667886,32667900,32667946,32667978,32668028,32668030,32668173,32668290,32668329,32668446,32668492,32668542,32668572,32668588,32668614,32668617,32668643,32668692,32668854,32668870,32669123,32669260,32669269,32669270,32669373,32670026,32670048,32670406,32670579,32670916,32670921,32670975,32671674,32671689,32671695,32671739,32671759,32671763,32671875,32671917,32672064,32672114,32672130,32672187,32672196,32672218,32672317,32672321,32672379,32672481,32672522,32672549,32672562,32672601,32672702,32673102,32673257,32673370,32673377,32673667,32673680,32673744,32673881,32673922,32673949,32674055,32675446,32675946,32675947,32675981,32675999,32676056,32676100,32676119,32676251,32676350,32676395,32676637,32676643,32676683,32676733,32676742,32676784,32676950,32677198,32677442,32677474,32677847,32678023,32678029,32678085,32678134,32679066,32679498,32679645,32680001,32680026,32680116,32680229,32680414,32680494,32680523,32115325,32116497,32128395,32168767,32176916,32209624,32245280,32255424,32255741,32259899,32503551,30918694,30937884,30939239,30953230,31098265,31126652,31193831,31212236,31219489,31152513,31184744,30768003,31033453,31074983,30639026,30693712,31250112,30786636,30811155,30876288,30896892,6853731,6860261,6462266,6752778,6766096,6674840,6695785,6707780,6645957,6595866,6150560,6382844,6389453,6409105,6773960,6779168,4009941,4024695,3837987,3694171,3517588,3539227,3604324,7592241,7215260,7216321,7493766,7357261,7124476,6924973,6943410,7297675,7027323,7028002,7062863,7068710,7484732,6028389,5919068,5955527,5529507,5851131,5715037,5470638,5883703,5899938,1252383,1260052,1367839,1173838,1237097,1266026,1285892,1294056,1299795,1413641,1451254,1149651,700460,664874,686530,1021996,583708,590802,599811,601454,722065,728690,563952,614954,629600,654198,765148,807968,821918,3002641,3004161,2996951,2962337,2976741,2924066,2737095,2859446,2765318,2768391,2815372,2905941,2728000,2014146,2032445,2329419,2105824,2091830,2261678,1933427,2191238,2204579,1966430,2147265,2064794,2238547,2279420,2286629,2298436,2302531,2316817,4371081,4100510,6617,508527,435016,444091,83760,101560,110905,115565,384459,356810,359015,366278,317834,330264,276914,241237,427551,168146,55574,56524,474924,146255,7767004,7842701,7855242,7863897,8064604,8071673,8073655,7673274,8129661,8205673,7892919,7921190,7823706,1902885,1888668,1702216,1844496,1857778,1859875,1574468,1755112,1787182,3024873,3457179,3460840,3397697,3339597,3121120,3241361,3163182,3209586,2649378,2656375,2671733,2481943,2587035,2544795,2414937,2458210,2603257,5125656,5144160,4931216,5099084,5110106,5115675,5005233,5032878,4773328,22536290,22897132,22482275,22573934,22558088,22943993,22946216,22949737,22512055,22446309,22450206,22460412,21879048,21989775,22001459,21961949,22080960,21822482,21822873,22008656,23036817,23200120,23200390,23007867,23014292,23086368,23060960,23071996,23074817,23101948,23107069,23022155,23032560,23114978,22315766,22332656,22118629,22339784,22345688,22240994,22409928,24036160,23884273,23977548,23895917,23952124,23627773,23478650,23456328,23553323,23573191,23582759,23469582,24358996,24367975,24305071,24306857,24312143,24381293,20902112,20911393,20872256,20646593,20989767,20751983,20756505,21649940,21574335,21757590,21496134,24830547,24727887,24712964,24770904,24777613,24793537,24255660,24227982,24236179,24069968,24077914,24088756,24164057,24208006,24218531,24136703,24153730,24119880,21379701,21390186,21395668,21215399,21346533,21454847,21465697,21474569,21271845,21145622,24497646,24522158,24610667,24512704,24586548,24475723,24680154,23263013,23254541,23214172,23305591,23733363,23736250,23698152,23723401,23714185,23772313,17773882,17607805,17669159,17691115,17499041,17971155,14734842,14408336,14700265,14710090,14613714,14536544,14536658,14538943,14494299,14432386,16461418,16462224,16475050,16378807,16353367,16396687,16307065,16192804,16193152,16204470,16217099,16283859,15128425,14840963,14844474,15049096,15066870,15036162,14909865,14915571,14919080,14920499,14991575,14878680,19848612,20018102,19789598,19950525,19955241,19659323,19918347,19694456,19991092,16151747,16135631,15950054,15955510,16171944,16183516,16120502,15941362,14206898,14291879,14358651,14333840,14089681,14379258,14384596,14217774,17205643,16978544,16963886,17280577,17374877,17382485,17151019,16906338,19544269,19363453,19274532,19258171,19319644,19449560,19555181,19205084,19328960,19415079,19472337,15685025,15798860,15802355,15761325,15585611,15615194,15620020,15504894,15188495,15444550,15468084,15301734,15396518,15228495,15229570,15240175,15333146,20391226,20246044,20335369,18563496,18563855,18293902,18535709,18197134,18247037,18338686,18301564,18412969,18421592,16795688,16800932,16754599,16738320,16645193,16647741,16524195,16607772,16706888,18859239,18962253,26851177,26858705,26879604,26694160,26812359,26795309,27761751,27647820,27656795,27868788,27882620,27642828,27835554,27856203,27859047,27765798,27767973,27819075,27823898,27825028,27825988,27743146,25746478,25835180,25793186,25736381,25856750,25838160,25845811,25698612,25699969,25811250,27515407,27519248,27569903,27439571,27301782,27524598,27338446,27545938,27553087,27350136,27365412,25360101,25241904,25252267,25230145,25332190,28586728,28390774,28355663,28474704,28533339,28534347,28339107,28592096,28604994,28409183,28549221,29182853,28712340,28982729,28993850,28677859,28686411,28713761,28718634,28731060,28736247,28756729,29104185,28882723,28807785,28822687,28828215,28843772,28844156,28849655,28762049,28921685,27054729,27023770,27030566,27039906,27068578,27184072,27189518,27198224,27251674,27280622,27281308,27100076,26300668,26270761,26273142,26275514,26200344,26200849,26135210,24916283,24916715,24919835,25041967,25130634,25130654,26632536,26644925,26535192,26613321,26434582,26385630,26577151,26474069,26481317,26453576,26026809,26035518,26127510,25877801,25983270,25941363,25946100,26041125,26053418,26055154,25998268,26001098,29285349,29771104,29809704,29639783,29393460,29227741,29329653,29344213,29245186,29266086,29574503,29612850,25435874,25606892,25541211,25488940,25452971,28150884,28138136,28277270,28255170,28225975,27949730,28010497,28022817,28091826,28312015,13835825,14029559,14033527,11929275,11932095,12032015,12019267,12022167,11967758,11803195,11805867,11790558,11897226,11832337,11848312,12391775,12486303,12493243,12480251,12483380,12361547,12441788,12758131,12770683,12820060,12784724,12638776,12642952,12849277,12841895,9962550,10312919,10281649,10009633,10077382,9921637,10093950,10102803,9938484,13081971,13083382,13120296,12974072,13107541,13073277,12950969,12996406,12999360,13003392,13045740,13056992,13010762,12916350,12918080,12918497,9567285,9590274,9738155,9692417,9610000,9542075,9547403,9361485,9471889,9420587,9261612,9236624,9203155,9212332,9182112,9165967,9069197,8934598,9097542,9319863,9335933,9023397,12243736,12245718,12196788,12149439,12227300,12100452,12312534,12315786,12317078,12114399,12071214,12072746,11772956,11655877,11546229,11547772,11733269,11739070,11740381,11742344,11599673,11566150,13450496,13502061,13487058,13575726,13530618,13540796,8851910,8799493,8801014,8280959,8550172,8350791,8612576,8412949,8589098,8647060,8666079,8671777,8672561,13212226,13263333,13337207,13361978,10589424,10851093,10808779,10736559,10691377,10702426,10708287,10439255,10410001,10484224,10495021,10502360,10399024,10890710,10914636,10946594,10961486,10965025,10975217,11202149,11374364,11384523,11148403,11168662,11118543,11123580,11001016,11078848,11091096,11314981,11316827,11059063,11302749,11310297,11226988,11227838,11237980,11436206]

GenerateMwebUrl.generate_url_for_users(users)